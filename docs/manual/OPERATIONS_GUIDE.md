# ğŸ¥› Milk API Manager System - æ“ä½œæ‰‹å†Š (MVP v1.0)

## 1. ç³»çµ±ç°¡ä»‹
æœ¬ç³»çµ±æ˜¯åŸºæ–¼ **Apache APISIX** æ§‹å»ºçš„ä¼æ¥­ç´š API ç®¡ç†å¹³å°ï¼Œæ•´åˆäº† **AI é©…å‹•çš„è‡ªå‹•åŒ–æ©Ÿåˆ¶**ã€**å‹•æ…‹å®‰å…¨ç­–ç•¥**èˆ‡**å…¨æ–¹ä½ç›£æ§æµæ°´ç·š**ã€‚

---

## 2. ç’°å¢ƒå•Ÿå‹•æŒ‡å— (Windows 11)

### å‰ææ¢ä»¶
*   **Docker Desktop**: å·²å®‰è£ä¸¦å•Ÿå‹•ã€‚
*   **Git**: ç”¨æ–¼åŒæ­¥ä»£ç¢¼ã€‚
*   **.NET 8 SDK**: ç”¨æ–¼åŸ·è¡Œå¾Œç«¯èˆ‡ UIã€‚

### å•Ÿå‹•æ­¥é©Ÿ
1.  é–‹å•Ÿ PowerShell ä¸¦é€²å…¥å°ˆæ¡ˆç›®éŒ„ã€‚
2.  åŸ·è¡Œï¼š`.\start-all.bat` æˆ–ä½¿ç”¨ docker-composeï¼š`docker-compose up -d`ã€‚
3.  ç³»çµ±å°‡å•Ÿå‹•ä¸‹åˆ—ä¸»è¦å®¹å™¨èˆ‡æœå‹™ï¼ˆç¤ºä¾‹ç«¯å£ï¼‰ï¼š

- APISIX data plane: `9080`
- APISIX admin API: `9180`
- APISIX Dashboard: `9000`
- Prometheus: `9090`
- Grafana: `3000`
- Jaeger: `16686`
- Elasticsearch / Kibana / Logstash: `9200 / 5601 / 5044`

4.  å¦å¤–å•Ÿå‹•æœ¬åœ°éå®¹å™¨åŒ–æœå‹™ï¼ˆé¸ç”¨ï¼‰:

```powershell
# MilkApiManager (ASP.NET Core Web API)
cd backend\MilkApiManager
$env:ASPNETCORE_ENVIRONMENT="Development"
dotnet run --urls "http://localhost:5001"

# MilkAdminBlazor (Blazor Server UI)
cd ../MilkAdminBlazor
$env:ASPNETCORE_ENVIRONMENT="Development"
dotnet run --urls "http://localhost:5002"

# Flask wrapper (é¸ç”¨ï¼Œå•Ÿå‹• APISIX ç®¡ç†å°è£)
cd backend
set FLASK_APP=app.py
flask run --host=0.0.0.0 --port=5000
```

---

## 3. æ ¸å¿ƒåŠŸèƒ½æ“ä½œ

### A. IP é»‘åå–®ç®¡ç† (Traffic Blocker)
*   **è·¯å¾‘**: ç€è¦½å™¨è¨ªå• `http://localhost:5000/blacklist`
*   **æ“ä½œ**: 
    1. åœ¨è¼¸å…¥æ¡†è¼¸å…¥è¦é˜»æ–·çš„ IPï¼ˆä¾‹å¦‚ `127.0.0.1` é€²è¡Œæœ¬åœ°æ¸¬è©¦ï¼‰ã€‚
    2. é»æ“Š "Add to Blacklist"ã€‚
*   **é©—è­‰**: å˜—è©¦è¨ªå• `http://localhost:9080`ï¼Œç³»çµ±æ‡‰å›å‚³ **403 Forbidden**ã€‚

### B. API æ²»ç†èˆ‡è·¯ç”±æ¸…å–®
*   **è·¯å¾‘**: ç€è¦½å™¨è¨ªå• `http://localhost:5000/apis`
*   **åŠŸèƒ½**: æŸ¥çœ‹ç›®å‰ç¶²é—œè¨—ç®¡çš„æ‰€æœ‰ API è·¯ç”±ã€å°æ‡‰è·¯å¾‘åŠé¢¨éšªç­‰ç´š (L1-L3)ã€‚

### C. API å¯†é‘°è‡ªå‹•åŒ–è¼ªè½‰ (Secret Rotation)
*   **å¾Œç«¯é›†æˆ**: ç³»çµ±å·²èˆ‡ HashiCorp Vault æ•´åˆã€‚
*   **æ“ä½œ**: è¼ªè½‰ä»»å‹™ç›®å‰ç”± `SecurityAutomationService` æ ¹æ“šåˆè¦é€±æœŸè‡ªå‹•åŸ·è¡Œï¼Œäº¦å¯é€é API æ‰‹å‹•è§¸ç™¼ã€‚

---

## 4. ç›£æ§èˆ‡è§€æ¸¬ç³»çµ± (Observability)

| æœå‹™ | è¨ªå•è·¯å¾‘ | ç”¨é€” |
| :--- | :--- | :--- |
| **Milk Admin UI (Flask wrapper)** | `http://localhost:5000` | æ ¸å¿ƒç®¡ç† API å°è£ï¼ˆGET/POST/DELETE æ“ä½œï¼Œæ³¨æ„å¯«å…¥ç«¯éœ€é©—è­‰ï¼‰ |
| **Grafana** | `http://localhost:3000` | å³æ™‚æµé‡èˆ‡é˜»æ–·æ•¸æ“šå¯è¦–åŒ– |
| **Kibana** | `http://localhost:5601` | ç¨½æ ¸æ—¥èªŒ (Audit Log) æ·±åº¦æŸ¥è©¢ |
| **APISIX Dashboard** | `http://localhost:9000` | ç¶²é—œåŸç”Ÿé…ç½®ä»‹é¢ |
| **Jaeger** | `http://localhost:16686` | åˆ†æ•£å¼éˆè·¯è¿½è¹¤ (Tracing) |

---

## 5. å¸¸è¦‹å•é¡Œæ’é™¤ (Troubleshooting)

*   **å®¹å™¨å•Ÿå‹•å¤±æ•—**: è«‹åŸ·è¡Œ `docker-compose logs -f` æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒã€‚
*   **etcd é€£ç·šå•é¡Œ**: ç¢ºä¿ `etcd` æ­£å¸¸å•Ÿå‹•ä¸”ç«¯é»å¯é€£ç·šï¼ˆ`http://etcd:2379`ï¼‰ï¼Œåœ¨æœ¬åœ°æ¸¬è©¦å¯æª¢æŸ¥ `curl http://localhost:2379/health`ã€‚
*   **APISIX Admin 403/æ‹’çµ•å­˜å–**: æª¢æŸ¥ `apisix_conf/config.yaml` ä¸­ `allow_admin` èˆ‡ `admin_key` è¨­å®šï¼Œæ¸¬è©¦æ™‚å¯æš«æ™‚é–‹æ”¾ `allow_admin: 0.0.0.0/0`ï¼ˆåƒ…é™æ¸¬è©¦ç’°å¢ƒï¼‰ã€‚
*   **MilkAdminBlazor å‡ºç¾ HTTP 500 ä¸¦æç¤ºæ‰¾ä¸åˆ° fallback endpoint `/ _Host`**: ç¢ºä¿ `Pages/_Host.cshtml` æœ‰ `@page "/"` ä¸¦åœ¨ `Development` æ¨¡å¼ä¸‹å•Ÿå‹•ï¼ˆå¯é¡¯ç¤ºé–‹ç™¼éŒ¯èª¤é é¢ä»¥åˆ©æ’æŸ¥ï¼‰ã€‚
*   **Swagger ç„¡æ³•é¡¯ç¤º**: `MilkApiManager` åªåœ¨ `Development` ç’°å¢ƒå•Ÿç”¨ Swaggerï¼Œè«‹è¨­å®š `ASPNETCORE_ENVIRONMENT=Development`ã€‚
*   **Flask POST (å¯«å…¥) å›å‚³ 500**: ç›®å‰è§€å¯Ÿåˆ° GET ç«¯é»æ­£å¸¸ã€POST ç«¯é»å¤šç‚ºæ‡‰ç”¨ä¾‹å¤–ï¼Œè«‹å•Ÿç”¨ Flask debug æˆ–æª¢æŸ¥ `app.py` çš„ä¾‹å¤–è™•ç†ï¼Œå»ºè­°å…ˆåœ¨æœ¬æ©Ÿä»¥ï¼š

```powershell
set FLASK_ENV=development
set FLASK_APP=app.py
flask run --host=0.0.0.0 --port=5000
```

ä»¥å–å¾—è©³ç´°çš„ exception stack traceã€‚
*   **ä¸è¦æŠŠ build ç”¢ç‰©åŠ å…¥ç‰ˆæœ¬æ§åˆ¶**: è‹¥èª¤å°‡ `bin/` / `obj/` ç­‰åŠ å…¥ repoï¼Œæ‡‰æ–°å¢æˆ–æ›´æ–° `.gitignore`ï¼Œä¸¦å¾ index ç§»é™¤ï¼ˆç¤ºä¾‹å‘½ä»¤ï¼‰ï¼š

```powershell
git add .gitignore
git rm -r --cached **/bin **/obj
git add -A
git commit -m "chore: add .gitignore and remove build artifacts from index"
git push origin main
```

---
*Generated/updated from local troubleshooting on 2026-02-11*

---
*Generated by Milk AI Assistant on 2026-02-10*
