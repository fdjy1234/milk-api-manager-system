#!/bin/bash
# Unified Verification Script (Linux/WSL)
# This script is the "Source of Truth" for development stability.

set -e
REPORT_FILE="E2E_TEST_REPORT.md"
START_TIME=$(date +%s)

echo "==========================================================="
echo "   MILK API MANAGER - FULL SYSTEM VERIFICATION"
echo "==========================================================="

# 1. Infrastructure Check
echo -e "\n[Step 1/4] Checking Infrastructure (Docker)..."
REQUIRED_CONTAINERS=("apisix" "etcd" "prometheus" "grafana")
MISSING=()

for container in "${REQUIRED_CONTAINERS[@]}"; do
    if ! docker ps --format '{{.Names}}' | grep -q "$container"; then
        MISSING+=("$container")
    fi
done

if [ ${#MISSING[@]} -gt 0 ]; then
    echo "   ✗ Missing: ${MISSING[*]}"
else
    echo "   ✓ All core infrastructure containers are running."
fi

# Wait for key services to be READY (Crucial for CI stability)
echo -e "\n[Wait] Verifying Service Connectivity..."
for i in {1..30}; do
    if curl -s http://localhost:9180/apisix/admin/routes -H "X-API-KEY: edd1c9f034335f136f87ad84b625c88b" > /dev/null; then
        echo "   [PASS] APISIX Gateway is READY."
        break
    fi
    [ $i -eq 30 ] && echo "   [WARN] APISIX wait timed out."
    sleep 2
done

# 2. .NET Unit Tests
echo -e "\n[Step 2/4] Running .NET Unit Tests..."
if dotnet test backend/MilkApiManager.Tests/MilkApiManager.Tests.csproj --logger "console;verbosity=normal"; then
    DOTNET_STATUS="✅ OK"
    DOTNET_CODE=0
else
    DOTNET_STATUS="❌ FAIL"
    DOTNET_CODE=1
fi

# 3. Python Smoke Tests
echo -e "\n[Step 3/4] Running API Smoke Tests..."
if python3 test_complete.py; then
    SMOKE_STATUS="✅ OK"
    SMOKE_CODE=0
else
    SMOKE_STATUS="❌ FAIL"
    SMOKE_CODE=1
fi

# 4. Playwright E2E Tests
echo -e "\n[Step 4/4] Running Playwright E2E Tests..."
cd e2e
# Ensure dependencies are present
if [ ! -d "node_modules" ]; then
    echo "   [Info] Installing E2E dependencies..."
    npm install --silent
    npx playwright install --with-deps chromium > /dev/null 2>&1
fi

export BASE_URL="http://localhost:5000"
if npm test; then
    E2E_STATUS="✅ OK"
    E2E_CODE=0
else
    E2E_STATUS="❌ FAIL"
    E2E_CODE=1
fi
cd ..

# Generate Consolidated Report
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
OVERALL_STATUS="FAILED ❌"
if [ $DOTNET_CODE -eq 0 ] && [ $SMOKE_CODE -eq 0 ] && [ $E2E_CODE -eq 0 ]; then
    OVERALL_STATUS="PASSED ✅"
fi

cat <<EOF > "$REPORT_FILE"
# System Verification Report ($(date '+%Y-%m-%d %H:%M:%S'))

## Summary
- **Duration:** ${DURATION} seconds
- **Overall Status:** $OVERALL_STATUS

## Component Breakdown
| Component | Status | Details |
|-----------|--------|---------|
| .NET Backend | $DOTNET_STATUS | 48 Unit Tests |
| API Gateway | $SMOKE_STATUS | Python Smoke Test |
| Admin UI | $E2E_STATUS | Playwright E2E |

---
*Generated by OpenClaw Development Flow*
EOF

# Output to GitHub Summary if available
if [ -n "$GITHUB_STEP_SUMMARY" ]; then
    cat "$REPORT_FILE" >> "$GITHUB_STEP_SUMMARY"
fi

echo -e "\nReport generated: $REPORT_FILE"
echo "==========================================================="
