@page "/mock-lab"
@using MilkAdminBlazor.Data
@inject ApisixService ApisixService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true"><MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Large" Class="mr-2"/> API Mock Lab</MudText>
    <MudText Typo="Typo.body1" Class="text-muted mb-4">Simulate backend responses for your routes without writing a single line of backend code.</MudText>

    <MudTable Items="@rules" Hover="true" Elevation="2">
        <HeaderContent>
            <MudTh>Route ID</MudTh>
            <MudTh>Status Code</MudTh>
            <MudTh>Content Type</MudTh>
            <MudTh>Active</MudTh>
            <MudTh Style="text-align:right">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd><code>@context.RouteId</code></MudTd>
            <MudTd><MudChip T="string" Color="@(context.ResponseStatusCode < 400 ? Color.Success : Color.Error)">@context.ResponseStatusCode</MudChip></MudTd>
            <MudTd>@context.ContentType</MudTd>
            <MudTd><MudSwitch @bind-Value="@context.IsEnabled" Color="Color.Primary" UncheckedColor="Color.Default" @onclick="() => ToggleRule(context)"/></MudTd>
            <MudTd Style="text-align:right">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => EditRule(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteRule(context.Id)" />
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Class="mt-4" OnClick="AddNew">Create Mock Response</MudButton>
</MudContainer>

<MudDialog @bind-IsVisible="showModal" Options="dialogOptions">
    <TitleContent><MudText Typo="Typo.h6">Configure Mock Response</MudText></TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="editingRule.RouteId" Label="Route ID" />
        <MudNumericField @bind-Value="editingRule.ResponseStatusCode" Label="HTTP Status Code" Min="100" Max="599" />
        <MudTextField @bind-Value="editingRule.ContentType" Label="Content-Type" />
        <MudTextField @bind-Value="editingRule.ResponseBody" Label="Response Body (JSON)" Lines="5" Class="mt-2 font-monospace" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => showModal = false">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save">Save & Sync</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ApisixService.MockRuleDto> rules = new();
    private bool showModal;
    private ApisixService.MockRuleDto editingRule = new();
    private DialogOptions dialogOptions = new() { FullWidth = true, MaxWidth = MaxWidth.Medium };

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load() => rules = await ApisixService.GetMockRulesAsync();

    private void AddNew() { editingRule = new(); showModal = true; }

    private void EditRule(ApisixService.MockRuleDto rule) { editingRule = rule; showModal = true; }

    private async Task Save() { await ApisixService.SaveMockRuleAsync(editingRule); showModal = false; await Load(); }

    private async Task DeleteRule(int id) { await ApisixService.DeleteMockRuleAsync(id); await Load(); }

    private async Task ToggleRule(ApisixService.MockRuleDto rule) { rule.IsEnabled = !rule.IsEnabled; await ApisixService.SaveMockRuleAsync(rule); }
}
