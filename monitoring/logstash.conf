input {
  # 接收來自後端 AuditLogService 的 HTTP JSON
  http {
    port => 8080
    codec => json
    type => "backend-audit"
  }
  
  # 接收來自 APISIX (例如透過 http-logger 插件) 的日誌
  http {
    port => 8081
    codec => json
    type => "gateway-access"
  }
}

filter {
  if [type] == "gateway-access" {
    # 解析 APISIX 傳來的複雜 JSON 結構
    date {
      match => [ "start_time", "UNIX_MS" ]
      target => "@timestamp"
    }
    
    # 提取關鍵欄位
    mutate {
      add_field => { "client_ip" => "%{[client_ip]}" }
      add_field => { "request_uri" => "%{[uri]}" }
      add_field => { "response_status" => "%{[response][status]}" }
    }
  }
  
  if [type] == "backend-audit" {
    # 標註來源
    mutate {
      add_field => { "source_system" => "MilkApiManager" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "milk-api-%{type}-%{+YYYY.MM.dd}"
    # ELK 9.x 建議顯式關閉 ILM 如果是開發測試環境
    ilm_enabled => false
  }
  
  # 同時輸出到控制台方便偵錯
  stdout { codec => rubydebug }
}
